# Android Manager - Enterprise Device Management

Enterprise Android app with **AMAPI DPC (Device Policy Controller)** for zero-touch provisioning, policy enforcement, and remote device control.

---

## ğŸ¯ **Key Features**

### AMAPI DPC Integration
- âœ… **QR Code Provisioning** - Zero-touch device enrollment
- âœ… **Policy Enforcement** - Passwords, factory reset, developer settings
- âœ… **Compliance Reporting** - Reports status back to Google AMAPI
- âœ… **Custom DPC** - Directly enforces policies (not Google's DPC)

### Device Management
- âœ… **Remote Lock/Unlock** - Via Firebase Cloud Messaging
- âœ… **Real-time Location Tracking** - Smart throttling (15 min/50 meters)
- âœ… **Factory Reset Protection (FRP)** - Google account binding
- âœ… **Device Owner Mode** - Full administrative control
- âœ… **Mandatory Screen Lock** - Forces PIN/Pattern/Password
- âœ… **App Hidden from Launcher** - Invisible to end users
- âœ… **Crashlytics Integration** - Remote crash reporting

### Backend Integration
- âœ… **Automated Registration** - Auto-registers on first boot
- âœ… **FCM Push Notifications** - Real-time lock/unlock commands
- âœ… **Location Reporting** - Periodic updates with online status
- âœ… **Lock Screen Shop Info** - Fetches shop name/phone from API

---

## ğŸ—ï¸ **Tech Stack**

| Component | Technology |
|-----------|------------|
| **Language** | Kotlin |
| **UI** | Jetpack Compose |
| **Networking** | Retrofit + OkHttp |
| **Storage** | DataStore Preferences |
| **Push Notifications** | Firebase Cloud Messaging |
| **Crash Reporting** | Firebase Crashlytics |
| **Location** | Google Play Services Location |
| **Enterprise** | Android Management API (AMAPI) |

---

## ğŸ“± **AMAPI DPC Provisioning**

### QR Code Format

```json
{
  "android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME": "com.androidmanager/.receiver.DeviceAdminReceiver",
  "android.app.extra.PROVISIONING_DEVICE_ADMIN_PACKAGE_DOWNLOAD_LOCATION": "https://github.com/pratee-k-umar/Android-MDM/releases/download/v1.0.0/app-release.apk",
  "android.app.extra.PROVISIONING_DEVICE_ADMIN_SIGNATURE_CHECKSUM": "YeMTxf75z1Deyf3mhZd6OnPPX-SSafTaTfR8S-RNKWc",
  "android.app.extra.PROVISIONING_SKIP_ENCRYPTION": false,
  "android.app.extra.PROVISIONING_LEAVE_ALL_SYSTEM_APPS_ENABLED": true,
  "android.app.extra.PROVISIONING_ADMIN_EXTRAS_BUNDLE": {
    "backend_url": "https://your-backend.com/api",
    "enrollment_token": "YOUR_AMAPI_TOKEN",
    "customer_id": "CUSTOMER_ID",
    "enterprise_id": "enterprises/LC04j9pb5k"
  }
}
```

### Provisioning Flow

1. **Factory reset device**
2. **Tap 6x on "Let's Go"** screen to open QR scanner
3. **Scan QR code** (generated by backend)
4. **Android downloads APK** from GitHub releases
5. **App becomes Device Owner** automatically
6. **Policies enforced** (password, factory reset disabled, etc.)
7. **Device registered** with backend
8. **Ready for remote management** âœ…

---

## ğŸ” **Supported AMAPI Policies**

| Policy | Enforcement |
|--------|-------------|
| `passwordRequirements` | NUMERIC, min length, etc. |
| `factoryResetDisabled` | Blocks factory reset |
| `advancedSecurityOverrides.developerSettings` | Disables developer options |
| `stayOnPluggedModes` | Screen stays on when charging |
| `frpAdminEmails` | Google account for FRP |
| `applications[].permissionGrants` | Auto-grant permissions |
| `cameraDisabled` | Disables camera |
| `screenCaptureDisabled` | Blocks screenshots |
| `usbFileTransferDisabled` | Blocks USB file transfer |

---

## ğŸš€ **Quick Start**

### 1. Clone & Setup

```bash
git clone https://github.com/pratee-k-umar/Android-MDM.git
cd AndroidManager

# Add google-services.json to app/
```

### 2. Configure Backend URL

**File:** `app/src/main/java/com/androidmanager/util/Constants.kt`

```kotlin
object Constants {
    const val BACKEND_URL = "https://your-backend.com"
}
```

### 3. Build Release APK

```bash
./gradlew clean assembleRelease
```

**APK:** `app/build/outputs/apk/release/app-release.apk`

### 4. Get Signature Checksum

```bash
sha256sum app/build/outputs/apk/release/app-release.apk | xxd -r -p | base64 | tr '+/' '-_' | tr -d '='
```

**Current checksum:** `YeMTxf75z1Deyf3mhZd6OnPPX-SSafTaTfR8S-RNKWc`

### 5. Upload to GitHub Releases

Create a release and upload `app-release.apk`

---

## ğŸ“‚ **Project Structure**

```
app/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ api/            # AmapiClient (policy fetch/compliance)
â”‚   â”œâ”€â”€ local/          # PreferencesManager
â”‚   â”œâ”€â”€ model/          # AmapiPolicy, DeviceState, etc.
â”‚   â”œâ”€â”€ remote/         # Retrofit API service
â”‚   â””â”€â”€ repository/     # DeviceRepository
â”œâ”€â”€ manager/
â”‚   â”œâ”€â”€ AmapiPolicyEnforcer.kt    # Translates AMAPI â†’ DPM
â”‚   â”œâ”€â”€ AmapiPolicyManager.kt     # Orchestrates policy sync
â”‚   â””â”€â”€ DevicePolicyManagerHelper.kt
â”œâ”€â”€ receiver/
â”‚   â””â”€â”€ DeviceAdminReceiver.kt    # AMAPI DPC receiver
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ DeviceMonitorService.kt   # Background location/heartbeat
â”‚   â””â”€â”€ EMIFirebaseMessagingService.kt
â”œâ”€â”€ ui/
â”‚   â”œâ”€â”€ lock/           # LockScreenActivity (kiosk mode)
â”‚   â””â”€â”€ setup/          # SetupActivity
â””â”€â”€ EMIDeviceManagerApp.kt
```

---

## ğŸ“¡ **FCM Commands**

### Lock Device
```json
{
  "type": "DEVICE_LOCK_STATUS",
  "action": "LOCK_DEVICE"
}
```

### Unlock Device
```json
{
  "type": "DEVICE_LOCK_STATUS",
  "action": "UNLOCK_DEVICE"
}
```

---

## ğŸ”§ **Backend Requirements**

Update these in your backend:

| Setting | Value |
|---------|-------|
| Component Name | `com.androidmanager/.receiver.DeviceAdminReceiver` |
| APK URL | Your GitHub releases URL |
| Signature Checksum | `YeMTxf75z1Deyf3mhZd6OnPPX-SSafTaTfR8S-RNKWc` |
| Package Name | `com.androidmanager` |

---

## ğŸ› **Troubleshooting**

### Provisioning Failed
- âœ… APK URL is HTTPS and accessible
- âœ… Signature checksum matches release APK
- âœ… Component name is exactly `com.androidmanager/.receiver.DeviceAdminReceiver`
- âœ… Device has internet during setup

### Policy Not Enforcing
- âœ… AMAPI enrollment token is valid
- âœ… Enterprise ID format: `enterprises/LC########`
- âœ… Check logs: `adb logcat | grep -E "(AMAPI|PolicyEnforcer)"`

### FCM Not Working
- âœ… Firebase billing enabled
- âœ… `google-services.json` present in `app/`
- âœ… Device registered with backend

---

## ğŸ“Š **Metrics & Compatibility**

| Metric | Value |
|--------|-------|
| Min SDK | 29 (Android 10) |
| Target SDK | 36 |
| APK Size | ~3.5 MB |
| Location Update | 15 min or 50m |
| FCM Response | < 2 seconds |

### Android Version Compatibility

| Feature | Android 10 | Android 11+ |
|---------|------------|-------------|
| setLocationEnabled() | âŒ Skipped | âœ… |
| setRequiredPasswordComplexity() | âš ï¸ ROM dependent | âœ… |
| Password enforcement | âœ… Legacy API | âœ… Modern API |
| Location tracking | âœ… | âœ… |

---

## ğŸ“– **Documentation**

- [BACKEND_INTEGRATION_GUIDE.md](BACKEND_INTEGRATION_GUIDE.md) - QR code generation
- [BUILD_RELEASE_GUIDE.md](BUILD_RELEASE_GUIDE.md) - APK build & hosting
- [AMAPI_API_DOCUMENTATION.md](AMAPI_API_DOCUMENTATION.md) - AMAPI API reference

---

## âš ï¸ **Important**

- Only deploy to devices you **own/manage**
- Ensure compliance with **local privacy laws**
- **Never commit** `google-services.json` or `*.jks` files
- QR provisioning requires **publicly accessible APK URL**

---

**Built for enterprise device management** ğŸš€
