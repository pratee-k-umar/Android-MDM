# Android Manager - Enterprise Device Management

Enterprise Android app with **AMAPI DPC (Device Policy Controller)** for qr code provisioning, policy enforcement, and remote device control.

---

## **Key Features**

### AMAPI DPC Integration
- **QR Code Provisioning** - Zero-touch device enrollment
- **Policy Enforcement** - Passwords, factory reset, developer settings
- **Compliance Reporting** - Reports status back to Google AMAPI
- **Custom DPC** - Directly enforces policies (not Google's DPC)

### Device Management
- **Remote Lock/Unlock** - Via Firebase Cloud Messaging
- **Real-time Location Tracking** - Smart throttling (15 min/50 meters)
- **Factory Reset Protection (FRP)** - Google account binding
- **Device Owner Mode** - Full administrative control
- **Mandatory Screen Lock** - Forces PIN/Pattern/Password
- **App Hidden from Launcher** - Invisible to end users
- **Crashlytics Integration** - Remote crash reporting

### Backend Integration
- **Automated Registration** - Auto-registers on first boot
- **FCM Push Notifications** - Real-time lock/unlock commands
- **Location Reporting** - Periodic updates with online status
- **Lock Screen Shop Info** - Fetches shop name/phone from API

---

## **Tech Stack**

| Component | Technology |
|-----------|------------|
| **Language** | Kotlin |
| **UI** | Jetpack Compose |
| **Networking** | Retrofit + OkHttp |
| **Storage** | DataStore Preferences |
| **Push Notifications** | Firebase Cloud Messaging |
| **Crash Reporting** | Firebase Crashlytics |
| **Location** | Google Play Services Location |
| **Enterprise** | Android Management API (AMAPI) |

---

## **AMAPI DPC Provisioning**

### QR Code Format

```json
{
  "android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME": "com.androidmanager/.receiver.DeviceAdminReceiver",
  "android.app.extra.PROVISIONING_DEVICE_ADMIN_PACKAGE_DOWNLOAD_LOCATION": "https://github.com/your-username/your-repo/releases/download/v1.0.0/app-release.apk",
  "android.app.extra.PROVISIONING_DEVICE_ADMIN_SIGNATURE_CHECKSUM": "YOUR_APK_SIGNATURE_CHECKSUM",
  "android.app.extra.PROVISIONING_SKIP_ENCRYPTION": false,
  "android.app.extra.PROVISIONING_LEAVE_ALL_SYSTEM_APPS_ENABLED": true,
  "android.app.extra.PROVISIONING_ADMIN_EXTRAS_BUNDLE": {
    "backend_url": "https://your-backend.com/api",
    "enrollment_token": "YOUR_ENROLLMENT_TOKEN",
    "customer_id": "YOUR_CUSTOMER_ID",
    "enterprise_id": "enterprises/YOUR_ENTERPRISE_ID"
  }
}
```

### Provisioning Flow

1. **Factory reset device**
2. **Tap 6x on "Let's Go"** screen to open QR scanner
3. **Scan QR code** (generated by backend)
4. **Android downloads APK** from GitHub releases
5. **App becomes Device Owner** automatically
6. **Policies enforced** (password, factory reset disabled, etc.)
7. **Device registered** with backend
8. **Ready for remote management**

---

## **Supported AMAPI Policies**

| Policy | Enforcement |
|--------|-------------|
| `passwordRequirements` | NUMERIC, min length, etc. |
| `factoryResetDisabled` | Blocks factory reset |
| `advancedSecurityOverrides.developerSettings` | Disables developer options |
| `stayOnPluggedModes` | Screen stays on when charging |
| `frpAdminEmails` | Google account for FRP |
| `applications[].permissionGrants` | Auto-grant permissions |
| `cameraDisabled` | Disables camera |
| `screenCaptureDisabled` | Blocks screenshots |
| `usbFileTransferDisabled` | Blocks USB file transfer |

---

## **Quick Start**

### 1. Clone & Setup

```bash
git clone https://github.com/your-username/your-repo.git
cd AndroidManager

# Add google-services.json to app/
```

### 2. Configure Backend URL

**File:** `app/src/main/java/com/androidmanager/util/Constants.kt`

```kotlin
object Constants {
    const val BACKEND_URL = "https://your-backend.com"
}
```

### 3. Build Release APK

```bash
./gradlew clean assembleRelease
```

**APK:** `app/build/outputs/apk/release/app-release.apk`

### 4. Get Signature Checksum

```bash
sha256sum app/build/outputs/apk/release/app-release.apk | xxd -r -p | base64 | tr '+/' '-_' | tr -d '='
```

### 5. Upload to GitHub Releases

Create a release and upload `app-release.apk`

---

## **Project Structure**

```
app/
├── data/
│   ├── api/            # AmapiClient (policy fetch/compliance)
│   ├── local/          # PreferencesManager
│   ├── model/          # AmapiPolicy, DeviceState, etc.
│   ├── remote/         # Retrofit API service
│   └── repository/     # DeviceRepository
├── manager/
│   ├── AmapiPolicyEnforcer.kt    # Translates AMAPI → DPM
│   ├── AmapiPolicyManager.kt     # Orchestrates policy sync
│   └── DevicePolicyManagerHelper.kt
├── receiver/
│   └── DeviceAdminReceiver.kt    # AMAPI DPC receiver
├── service/
│   ├── DeviceMonitorService.kt   # Background location/heartbeat
│   └── EMIFirebaseMessagingService.kt
├── ui/
│   ├── lock/           # LockScreenActivity (kiosk mode)
│   └── setup/          # SetupActivity
└── EMIDeviceManagerApp.kt
```

---

## **FCM Commands**

### Lock Device
```json
{
  "type": "DEVICE_LOCK_STATUS",
  "action": "LOCK_DEVICE"
}
```

### Unlock Device
```json
{
  "type": "DEVICE_LOCK_STATUS",
  "action": "UNLOCK_DEVICE"
}
```

---

## **Backend Requirements**

Update these in your backend:

| Setting | Value |
|---------|-------|
| Component Name | `com.androidmanager/.receiver.DeviceAdminReceiver` |
| APK URL | Your GitHub releases URL |
| Package Name | `com.androidmanager` |

---

## **Troubleshooting**

### Provisioning Failed
- APK URL is HTTPS and accessible
- Signature checksum matches release APK
- Component name is exactly `com.androidmanager/.receiver.DeviceAdminReceiver`
- Device has internet during setup

### Policy Not Enforcing
- AMAPI enrollment token is valid
- Enterprise ID format: `enterprises/########`
- Check logs: `adb logcat | grep -E "(AMAPI|PolicyEnforcer)"`

### FCM Not Working
- Firebase billing enabled
- `google-services.json` present in `app/`
- Device registered with backend

---

## **Metrics & Compatibility**

| Metric | Value |
|--------|-------|
| Min SDK | 29 (Android 10) |
| Target SDK | 36 |
| APK Size | ~3.5 MB |
| Location Update | 15 min or 50m |
| FCM Response | < 2 seconds |

### Android Version Compatibility

| Feature | Android 10 | Android 11+ |
|---------|------------|-------------|
| setLocationEnabled() | Skipped | Supported |
| setRequiredPasswordComplexity() | ROM dependent | Supported |
| Password enforcement | Legacy API | Modern API |
| Location tracking | Supported | Supported |

---

## **Documentation**

- [BACKEND_INTEGRATION_GUIDE.md](BACKEND_INTEGRATION_GUIDE.md) - QR code generation
- [BUILD_RELEASE_GUIDE.md](BUILD_RELEASE_GUIDE.md) - APK build & hosting
- [AMAPI_API_DOCUMENTATION.md](AMAPI_API_DOCUMENTATION.md) - AMAPI API reference

---

## **Important**

- Only deploy to devices you **own/manage**
- Ensure compliance with **local privacy laws**
- **Never commit** `google-services.json` or `*.jks` files
- QR provisioning requires **publicly accessible APK URL**

---

**Built for enterprise device management**
